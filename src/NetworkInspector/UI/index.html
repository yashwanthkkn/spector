<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Inspector</title>
    <style>
        :root {
            --bg-color: #0d1117;
            --sidebar-bg: #161b22;
            --text-color: #c9d1d9;
            --border-color: #30363d;
            --accent-color: #58a6ff;
            --success-color: #238636;
            --error-color: #da3633;
            --warning-color: #d29922;
            --method-get: #238636;
            --method-post: #1f6feb;
            --method-put: #d29922;
            --method-delete: #da3633;
            --hover-bg: #21262d;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar - Request List */
        .sidebar {
            width: 400px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .refresh-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .refresh-btn:hover {
            background-color: var(--hover-bg);
        }

        .request-list {
            flex: 1;
            overflow-y: auto;
        }

        .request-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 4px;
            transition: background-color 0.2s;
        }

        .request-item:hover {
            background-color: var(--hover-bg);
        }

        .request-item.active {
            background-color: rgba(88, 166, 255, 0.1);
            border-left: 3px solid var(--accent-color);
        }

        .req-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .req-method {
            font-size: 11px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 4px;
            color: white;
        }

        .method-GET { background-color: var(--method-get); }
        .method-POST { background-color: var(--method-post); }
        .method-PUT { background-color: var(--method-put); }
        .method-DELETE { background-color: var(--method-delete); }

        .req-status {
            font-size: 12px;
            font-weight: 600;
        }

        .status-2xx { color: var(--success-color); }
        .status-4xx, .status-5xx { color: var(--error-color); }

        .req-path {
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #8b949e;
        }

        .req-meta {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #8b949e;
        }

        /* Main Content - Details */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .empty-state {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #8b949e;
        }

        .details-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--bg-color);
        }

        .details-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            word-break: break-all;
        }

        .details-meta {
            display: flex;
            gap: 16px;
            font-size: 13px;
            color: #8b949e;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--sidebar-bg);
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-size: 14px;
        }

        .tab:hover {
            background-color: var(--hover-bg);
        }

        .tab.active {
            border-bottom-color: var(--accent-color);
            color: var(--text-color);
        }

        .tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        pre {
            background-color: var(--sidebar-bg);
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 0;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
            font-size: 13px;
            border: 1px solid var(--border-color);
        }

        .kv-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .kv-table td {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .kv-key {
            font-weight: 600;
            width: 30%;
            color: #8b949e;
        }

        .kv-value {
            word-break: break-all;
        }

        .sql-query {
            margin-bottom: 16px;
            border-left: 3px solid var(--accent-color);
            padding-left: 12px;
        }
        
        .sql-meta {
            font-size: 11px;
            color: #8b949e;
            margin-bottom: 4px;
        }

    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <span>Requests</span>
            <button class="refresh-btn" onclick="fetchRequests()">Refresh</button>
        </div>
        <div class="request-list" id="requestList">
            <!-- Items will be injected here -->
        </div>
    </div>

    <div class="main-content">
        <div id="emptyState" class="empty-state">
            Select a request to view details
        </div>
        <div id="detailsView" style="display: none; height: 100%; flex-direction: column;">
            <div class="details-header">
                <div class="details-title">
                    <span id="detailMethod" class="req-method" style="margin-right: 8px;">GET</span>
                    <span id="detailUrl">/api/users</span>
                </div>
                <div class="details-meta">
                    <span id="detailStatus">200 OK</span>
                    <span id="detailDuration">120ms</span>
                    <span id="detailTime">10:23:45</span>
                </div>
            </div>

            <div class="tabs">
                <div class="tab active" onclick="switchTab('headers')">Headers</div>
                <div class="tab" onclick="switchTab('body')">Body</div>
                <div class="tab" onclick="switchTab('sql')">SQL Queries</div>
                <div class="tab" onclick="switchTab('outgoing')">Outgoing Requests</div>
            </div>

            <div id="tab-headers" class="tab-content active">
                <h3>Request Headers</h3>
                <table class="kv-table" id="reqHeadersTable"></table>
                <h3>Response Headers</h3>
                <table class="kv-table" id="resHeadersTable"></table>
            </div>

            <div id="tab-body" class="tab-content">
                <h3>Request Body</h3>
                <pre id="reqBody">None</pre>
                <h3>Response Body</h3>
                <pre id="resBody">None</pre>
            </div>

            <div id="tab-sql" class="tab-content">
                <div id="sqlList"></div>
            </div>
            
            <div id="tab-outgoing" class="tab-content">
                <div id="outgoingList"></div>
            </div>
        </div>
    </div>

    <script>
        let currentRequests = [];
        let selectedRequestId = null;

        async function fetchRequests() {
            try {
                const response = await fetch('/_inspector/api/requests');
                const data = await response.json();
                currentRequests = data;
                renderRequestList();
            } catch (error) {
                console.error('Failed to fetch requests', error);
            }
        }

        function renderRequestList() {
            const list = document.getElementById('requestList');
            list.innerHTML = '';

            currentRequests.forEach(req => {
                const item = document.createElement('div');
                item.className = `request-item ${selectedRequestId === req.Id ? 'active' : ''}`;
                item.onclick = () => selectRequest(req.Id);

                const statusClass = req.StatusCode >= 200 && req.StatusCode < 300 ? 'status-2xx' : 'status-4xx';
                const time = new Date(req.Timestamp).toLocaleTimeString();

                item.innerHTML = `
                    <div class="req-top">
                        <span class="req-method method-${req.Method}">${req.Method}</span>
                        <span class="req-status ${statusClass}">${req.StatusCode}</span>
                    </div>
                    <div class="req-path">${req.Url}</div>
                    <div class="req-meta">
                        <span>${time}</span>
                        <span>${req.DurationMs}ms</span>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        async function selectRequest(id) {
            selectedRequestId = id;
            renderRequestList(); // Re-render to update active state

            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('detailsView').style.display = 'flex';

            // Fetch full details
            const response = await fetch(`/_inspector/api/requests/details?id=${id}`);
            const data = await response.json();
            renderDetails(data);
        }

        function renderDetails(data) {
            document.getElementById('detailMethod').textContent = data.Method;
            document.getElementById('detailMethod').className = `req-method method-${data.Method}`;
            document.getElementById('detailUrl').textContent = data.Url;
            document.getElementById('detailStatus').textContent = `${data.StatusCode}`;
            document.getElementById('detailDuration').textContent = `${data.DurationMs}ms`;
            document.getElementById('detailTime').textContent = new Date(data.Timestamp).toLocaleString();

            // Headers
            renderTable('reqHeadersTable', data.RequestHeaders);
            renderTable('resHeadersTable', data.ResponseHeaders);

            // Body
            document.getElementById('reqBody').textContent = formatBody(data.RequestBody);
            document.getElementById('resBody').textContent = formatBody(data.ResponseBody);

            // SQL & Outgoing
            const sqlList = document.getElementById('sqlList');
            sqlList.innerHTML = '';
            const outgoingList = document.getElementById('outgoingList');
            outgoingList.innerHTML = '';

            if (data.ChildEvents) {
                data.ChildEvents.forEach(evt => {
                    const evtData = JSON.parse(evt.toString()); // Assuming it might come as JsonElement
                    
                    if (evtData.Type === 'Database') {
                        const div = document.createElement('div');
                        div.className = 'sql-query';
                        div.innerHTML = `
                            <div class="sql-meta">Duration: ${evtData.DurationMs.toFixed(2)}ms</div>
                            <pre>${evtData.CommandText}</pre>
                        `;
                        sqlList.appendChild(div);
                    } else if (evtData.Type === 'OutgoingHttp') {
                        const div = document.createElement('div');
                        div.className = 'sql-query'; // Reuse style
                        div.style.borderLeftColor = '#d29922';
                        div.innerHTML = `
                            <div class="sql-meta">${evtData.Method} ${evtData.StatusCode} - ${evtData.DurationMs}ms</div>
                            <pre>${evtData.Url}</pre>
                        `;
                        outgoingList.appendChild(div);
                    }
                });
            }
            
            if (sqlList.children.length === 0) sqlList.innerHTML = '<div style="padding:16px; color:#8b949e">No SQL queries captured</div>';
            if (outgoingList.children.length === 0) outgoingList.innerHTML = '<div style="padding:16px; color:#8b949e">No outgoing requests captured</div>';
        }

        function renderTable(id, data) {
            const table = document.getElementById(id);
            table.innerHTML = '';
            if (!data) return;
            
            for (const [key, value] of Object.entries(data)) {
                const row = document.createElement('tr');
                row.innerHTML = `<td class="kv-key">${key}</td><td class="kv-value">${value}</td>`;
                table.appendChild(row);
            }
        }

        function formatBody(body) {
            if (!body) return 'None';
            try {
                return JSON.stringify(JSON.parse(body), null, 2);
            } catch {
                return body;
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // Find the tab element that was clicked (this is a bit hacky, better to pass 'this')
            // But since we have the onclick inline, we can just match by text or index.
            // Let's just use the event target in a real app, but here:
            const tabs = ['headers', 'body', 'sql', 'outgoing'];
            const index = tabs.indexOf(tabName);
            document.querySelectorAll('.tab')[index].classList.add('active');
            
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // Initial fetch
        fetchRequests();
        setInterval(fetchRequests, 5000); // Auto refresh every 5s
    </script>
</body>
</html>
